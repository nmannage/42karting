<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>42 Karting - Leaderboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --border:#e5e7eb; --text:#111827; --muted:#6b7280; --bg:#ffffff;
    --pill:#f3f4f6; --pill-wet-bg:rgba(59,130,246,.12);
    --pill-wet-bd:rgba(59,130,246,.35); --pill-wet-tx:#1e40af;
    --link:#1d4ed8;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:var(--text);background:var(--bg)}
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  .container{max-width:1100px;margin:0 auto;padding:1.5rem}

  /* HERO — fixed height, image fits with white letterbox */
  header{position:relative}
  .hero{
    position:relative;
    height:220px;
    border-bottom:1px solid var(--border);
    background:#fff;
    overflow:hidden;
  }
  .hero img.hero-img{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:contain;    /* fit without cropping */
    object-position:center;
  }
  .brand-wrap{position:absolute; left:1rem; bottom:1rem;}
  .brand{
    display:flex; align-items:center; gap:.75rem; color:#fff;
    background:rgba(17,24,39,.7);
    border:1px solid rgba(255,255,255,.18);
    padding:.6rem .9rem; border-radius:14px;
    backdrop-filter:saturate(1.2) blur(2px);
  }
  .brand img{height:56px; width:auto}
  h1{margin:.1rem 0 0; font-size:1.8rem}

  .controls{display:flex; gap:.5rem; flex-wrap:wrap; margin:1rem 0}
  select{padding:.4rem .5rem;border:1px solid var(--border);border-radius:8px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:.6rem .5rem;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
  th{font-weight:600}
  .rank,.time,.date{font-variant-numeric:tabular-nums}
  .user{display:flex;align-items:center;gap:.5rem}
  img.avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;flex:0 0 auto}
  .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:var(--pill);border:1px solid var(--border);font-size:.85rem}
  .pill.wet{background:var(--pill-wet-bg);border-color:var(--pill-wet-bd);color:var(--pill-wet-tx)}
  .section{margin-top:2rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px}
  .card h3{margin:.2rem 0 .6rem;font-size:1rem}
  .record{display:flex;align-items:center;gap:.5rem}
  .record .who{flex:1}

  /* Event details */
  #eventDetails{display:none}
  .event-card{border:1px solid var(--border);border-radius:12px;padding:16px}
  .event-header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
  .event-title{font-size:1.1rem;font-weight:600;margin:0}
  .event-meta{color:var(--muted);font-size:.95rem}
  .media-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:8px}
  .media-grid figure{margin:0}
  .media-grid img{width:100%;height:220px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .media-grid figcaption{font-size:.9rem;color:var(--muted);margin-top:6px}

  /* Race tables */
  .races{margin-top:1rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:12px}
  .race-card{border:1px solid var(--border); border-radius:12px; padding:12px}
  .race-card h3{margin:.2rem 0 .4rem; font-size:1rem}
  .race-card .meta{color:var(--muted); font-size:.9rem; margin-bottom:.4rem}
  .race-card table{width:100%}
  .race-card th, .race-card td{border-bottom:1px solid var(--border); padding:.4rem .3rem}

  /* Clickable text buttons (venue, school, event) — no layout shift */
  .plain-link{
    background:none; border:none; padding:0;
    color:inherit; font:inherit; cursor:pointer;
    display:inline-flex; align-items:center; gap:.25rem;
  }
  .plain-link::after{
    content:"›";                 /* always present */
    display:inline-block;
    width:1ch;                   /* reserve space so layout doesn't move */
    opacity:0;
    transform:translateX(-2px);
    transition:opacity .15s ease, transform .15s ease;
    pointer-events:none;
  }
  .plain-link:hover::after{
    opacity:1;
    transform:translateX(0);
  }
  /* keyboard focus without changing layout */
  .plain-link:focus-visible{
    outline:2px solid var(--link);
    outline-offset:2px;
    border-radius:6px;
  }
  
  @media (prefers-reduced-motion: reduce){
    .plain-link::after{ transition:none; }
  }

  @media (max-width:640px){
    .brand img{height:44px}
    h1{font-size:1.4rem}
  }
</style>
</head>
<body>
  <header>
    <div class="hero">
      <!-- try hero.jpg, then hero.png, then hero.svg, then fallback -->
      <img id="heroImg" class="hero-img" alt="">
      <div class="brand-wrap">
        <div class="brand">
          <img src="assets/logo.svg" alt="Logo"
               onerror="this.onerror=null;this.src='assets/fallbacks/logo.svg'">
          <div><h1>Go-Kart Leaderboard</h1></div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="controls">
      <label>School:
        <select id="schoolFilter"></select>
      </label>
      <label>Venue:
        <select id="venueFilter"></select>
      </label>
      <label>Event:
        <select id="eventFilter"></select>
      </label>
    </div>

    <!-- Events summary table (most recent first) -->
    <table id="eventsTable" class="section" aria-label="Events">
      <thead>
        <tr>
          <th>Venue</th>
          <th>Date</th>
          <th>Conditions</th>
          <th>School</th>
          <th>Event</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Event details -->
    <div id="eventDetails" class="section">
      <div class="event-card">
        <div class="event-header">
          <h2 class="event-title" id="evTitle"></h2>
          <span class="pill" id="evCond"></span>
        </div>
        <div class="event-meta" id="evMeta"></div>
        <div class="media-grid" id="evMedia"></div>
        <div class="races" id="evRaces"></div>
      </div>
    </div>

    <!-- Global best laps -->
    <table id="board" class="section" aria-label="Global best laptimes">
      <thead>
        <tr>
          <th>#</th>
          <th>Driver</th>
          <th>Best Lap</th>
          <th>Venue</th>
          <th>Date</th>
          <th>Conditions</th>
          <th>School</th>
          <th>Event</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="section">
      <h2>Venue records</h2>
      <div id="records" class="grid"></div>
    </div>
  </div>

<script>
/* ----------- hero loader (jpg -> png -> svg -> fallback) ----------- */
(function(){
  const el = document.getElementById('heroImg');
  const candidates = ['assets/hero.jpg','assets/hero.png','assets/hero.svg'];
  const fallback = 'assets/fallbacks/hero-fallback.svg';
  let i = 0;
  function tryNext(){
    if (i >= candidates.length){ el.src = fallback; return; }
    const src = candidates[i++];
    const test = new Image();
    test.onload = () => { el.src = src; };
    test.onerror = tryNext;
    test.src = src;
  }
  tryNext();
})();

/* ----------- helpers ----------- */
function toSeconds(t){
  if (typeof t === "number") return t;
  if (typeof t === "string" && t.includes(":")){
    const [mm, ss] = t.split(":"); const s = parseFloat(ss), m = parseInt(mm,10);
    if (Number.isFinite(s) && Number.isFinite(m)) return m*60 + s;
  }
  const n = Number(t);
  return Number.isFinite(n) ? n : NaN;
}
function fmtTime(sec){
  if (!Number.isFinite(sec)) return "";
  const m = Math.floor(sec/60), s = sec - m*60;
  return `${String(m).padStart(2,"0")}:${s.toFixed(3).padStart(6,"0")}`;
}
function isWet(cond){ return String(cond||"").toLowerCase().includes("wet"); }
function option(sel, val, text){ const o = document.createElement("option"); o.value = val; o.textContent = text; sel.appendChild(o); }
function userUrl(u){ return `https://profile-v3.intra.42.fr/users/${encodeURIComponent(u)}`; }
function dateScore(str){
  if (!str) return 0;
  // Support "DD/MM/YY", "DD/MM/YYYY", "YYYY-MM-DD"
  const s = String(str).trim();
  let d = 0;
  if (s.includes('/')){
    const [a,b,c] = s.split('/');
    if (a && b && c){
      let dd = parseInt(a,10), mm = parseInt(b,10)-1, yy = parseInt(c,10);
      if (c.length === 2) yy = 2000 + yy;
      d = Date.UTC(yy, mm, dd);
    }
  } else if (s.includes('-')){
    const [y,m,dn] = s.split('-');
    if (y && m && dn){
      d = Date.UTC(parseInt(y,10), parseInt(m,10)-1, parseInt(dn,10));
    }
  } else {
    const t = Date.parse(s);
    d = Number.isFinite(t) ? t : 0;
  }
  return Number.isFinite(d) ? d : 0;
}

/* Minimal parser for the TOML format used here */
function parseEventTOML(toml){
  const lines = toml.split(/\r?\n/);
  const meta = {};
  const drivers = [];
  const races = [];
  let curDriver = null;
  let curRace = null;
  let curEntry = null;

  function flushEntry(){ if (curEntry){ (curRace.entries || (curRace.entries=[])).push(curEntry); curEntry=null; } }
  function flushDriver(){ if (curDriver){ drivers.push(curDriver); curDriver=null; } }
  function flushRace(){ if (curRace){ flushEntry(); races.push(curRace); curRace=null; } }

  for (const raw of lines){
    const line = raw.trim();
    if (!line || line.startsWith("#")) continue;

    if (line === "[[drivers]]"){ flushEntry(); flushRace(); flushDriver(); curDriver = {}; continue; }
    if (line === "[[races]]"){ flushEntry(); flushRace(); curRace = {}; continue; }
    if (line === "[[races.entries]]"){ flushEntry(); if (!curRace) curRace = {}; curEntry = {}; continue; }

    const m = line.match(/^([A-Za-z0-9_]+)\s*=\s*(.+)$/);
    if (!m) continue;
    const key = m[1];
    let val = m[2].trim();
    if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) val = val.slice(1,-1);
    else if (!Number.isNaN(Number(val))) val = Number(val);

    if (curEntry){ curEntry[key] = val; continue; }
    if (curRace){ curRace[key] = val; continue; }
    if (curDriver){ curDriver[key] = val; continue; }
    meta[key] = val;
  }
  flushEntry(); flushRace(); flushDriver();
  return { meta, drivers, races };
}

/* ----------- data + render ----------- */
let ROWS = [];            // best per driver per event (for global table)
const EVENTS = new Map(); // eventId -> { meta, driversMap, races[] }

async function load(){
  const paths = await fetch("data/events.json", { cache:"no-store" }).then(r => r.json());
  const rows = [];

  for (const p of paths){
    const txt = await fetch(p, { cache:"no-store" }).then(r => r.text());
    const { meta, drivers, races } = parseEventTOML(txt);
    const id = meta.id || p;
    const name = meta.name || id;

    // drivers map for quick lookup
    const dmap = new Map();
    for (const d of drivers){ if (d.username) dmap.set(d.username, d.img || ""); }

    // compute best per user across all races in this event
    const best = new Map(); // username -> seconds
    for (const r of races){
      const entries = r.entries || [];
      for (const e of entries){
        const u = e.user || "";
        const t = toSeconds(e.laptime);
        if (!u || !Number.isFinite(t)) continue;
        const prev = best.get(u);
        if (prev == null || t < prev) best.set(u, t);
      }
    }

    // global rows: one per user per event
    for (const [u, t] of best){
      rows.push({
        username: u,
        img: dmap.get(u) || "",
        time: t,
        venue: meta.venue || "",
        date: meta.date || "",
        school: meta.school || "",
        conditions: meta.conditions || "",
        eventId: id,
        eventName: name
      });
    }

    EVENTS.set(id, {
      meta: {
        id, name,
        venue: meta.venue || "",
        date: meta.date || "",
        school: meta.school || "",
        conditions: meta.conditions || "",
        venue_img: meta.venue_img || "",
        track_img: meta.track_img || ""
      },
      driversMap: dmap,
      races: (races || []).map(r => ({
        id: r.id || "",
        name: r.name || "",
        laps: r.laps || "",
        conditions: r.conditions || "",
        entries: (r.entries || []).map(e => ({
          user: e.user || "",
          laptime: toSeconds(e.laptime)
        })).filter(e => e.user && Number.isFinite(e.laptime))
      }))
    });
  }

  ROWS = rows;
  initFilters();
  render();
}

function initFilters(){
  const schoolSel = document.getElementById("schoolFilter");
  const venueSel = document.getElementById("venueFilter");
  const eventSel = document.getElementById("eventFilter");
  schoolSel.innerHTML = ""; venueSel.innerHTML = ""; eventSel.innerHTML = "";

  const schools = new Set(["(All)"]);
  const venues = new Set(["(All)"]);
  for (const r of ROWS){ if (r.school) schools.add(r.school); if (r.venue) venues.add(r.venue); }

  [...schools].sort().forEach(s => option(schoolSel, s, s));
  [...venues].sort().forEach(v => option(venueSel, v, v));
  option(eventSel, "(All)", "(All)");
  [...EVENTS.entries()].sort((a,b)=>a[1].meta.name.localeCompare(b[1].meta.name))
    .forEach(([id, ev]) => option(eventSel, id, ev.meta.name));

  schoolSel.value="(All)"; venueSel.value="(All)"; eventSel.value="(All)";
  schoolSel.addEventListener("change", render);
  venueSel.addEventListener("change", render);
  eventSel.addEventListener("change", render);

  // click delegation for venue/school/event "plain-link" buttons
  document.addEventListener('click', (e)=>{
    const venueEl = e.target.closest('[data-venue]');
    const schoolEl = e.target.closest('[data-school]');
    const eventEl = e.target.closest('[data-event]');
    if (venueEl){
      const v = venueEl.getAttribute('data-venue') || '';
      if (v){ venueSel.value = v; render(); window.scrollTo({top:0, behavior:'smooth'}); }
    }
    if (schoolEl){
      const s = schoolEl.getAttribute('data-school') || '';
      if (s){ schoolSel.value = s; render(); window.scrollTo({top:0, behavior:'smooth'}); }
    }
    if (eventEl){
      const id = eventEl.getAttribute('data-event') || '';
      if (id){ document.getElementById('eventFilter').value = id; render();
        document.getElementById('eventDetails').scrollIntoView({behavior:'smooth', block:'start'});
      }
    }
  });
}

function render(){
  const schoolSel = document.getElementById("schoolFilter");
  const venueSel = document.getElementById("venueFilter");
  const eventSel = document.getElementById("eventFilter");

  const schoolVal = schoolSel.value;
  const venueVal = venueSel.value;
  const eventVal = eventSel.value;

  /* -------- Events summary table (most recent first) -------- */
  const eventsTBody = document.querySelector("#eventsTable tbody");
  eventsTBody.innerHTML = "";
  const eventsArr = [...EVENTS.values()].map(ev => ev.meta);
  eventsArr.sort((a,b)=>dateScore(b.date)-dateScore(a.date)); // newest first
  for (const m of eventsArr){
    // apply current School/Venue filters to this table too
    if (schoolVal !== "(All)" && m.school !== schoolVal) continue;
    if (venueVal !== "(All)" && m.venue !== venueVal) continue;

    const pillClass = isWet(m.conditions) ? "pill wet" : "pill";
    const tr = document.createElement("tr");
    const venueBtn = `<button class="plain-link" data-venue="${m.venue}">${m.venue}</button>`;
    const schoolBtn = `<button class="plain-link" data-school="${m.school}">${m.school}</button>`;
    const eventBtn = `<button class="plain-link" data-event="${m.id}">${m.name}</button>`;
    tr.innerHTML = `
      <td>${venueBtn}</td>
      <td class="date">${m.date}</td>
      <td><span class="${pillClass}">${m.conditions||""}</span></td>
      <td>${schoolBtn}</td>
      <td>${eventBtn}</td>
    `;
    eventsTBody.appendChild(tr);
  }

  /* -------- Global best table -------- */
  let rows = ROWS.slice();
  if (schoolVal !== "(All)") rows = rows.filter(r => r.school === schoolVal);
  if (venueVal !== "(All)") rows = rows.filter(r => r.venue === venueVal);
  if (eventVal !== "(All)") rows = rows.filter(r => r.eventId === eventVal);
  rows.sort((a,b)=>a.time-b.time);

  const tbody = document.querySelector("#board tbody");
  tbody.innerHTML = "";
  rows.forEach((r,i)=>{
    const pillClass = isWet(r.conditions) ? "pill wet" : "pill";
    const link = `<a href="${userUrl(r.username)}" target="_blank" rel="noopener">${r.username}</a>`;
    const avatarSrc = (r.img && r.img.trim()) ? r.img : 'assets/fallbacks/avatar.svg';
    const imgTag = `<img class="avatar" src="${avatarSrc}" alt="${r.username}"
                     onerror="this.onerror=null;this.src='assets/fallbacks/avatar.svg'">`;
    const venueBtn = `<button class="plain-link" data-venue="${r.venue}">${r.venue}</button>`;
    const schoolBtn = `<button class="plain-link" data-school="${r.school}">${r.school}</button>`;
    const eventBtn = `<button class="plain-link" data-event="${r.eventId}">${r.eventName||r.eventId}</button>`;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="rank">${i+1}</td>
      <td class="user">${imgTag}<span>${link}</span></td>
      <td class="time">${fmtTime(r.time)}</td>
      <td>${venueBtn}</td>
      <td class="date">${r.date}</td>
      <td><span class="${pillClass}">${r.conditions||""}</span></td>
      <td>${schoolBtn}</td>
      <td>${eventBtn}</td>
    `;
    tbody.appendChild(tr);
  });

  /* -------- Venue records -------- */
  const byVenue = new Map();
  for (const r of rows){
    if (!byVenue.has(r.venue)) byVenue.set(r.venue, []);
    byVenue.get(r.venue).push(r);
  }
  const wrap = document.getElementById("records");
  wrap.innerHTML = "";
  const cards = [];
  for (const [venue, arr] of byVenue){
    const best = arr.slice().sort((a,b)=>a.time-b.time)[0];
    if (!best) continue;
    const card = document.createElement("div");
    card.className = "card";
    const pillClass = isWet(best.conditions) ? "pill wet" : "pill";
    const linkBest = `<a href="${userUrl(best.username)}" target="_blank" rel="noopener">${best.username}</a>`;
    const recAvatar = (best.img && best.img.trim()) ? best.img : 'assets/fallbacks/avatar.svg';
    const venueBtn = `<button class="plain-link" data-venue="${venue}">${venue}</button>`;
    card.innerHTML = `
      <h3>${venueBtn}</h3>
      <div class="record">
        <img class="avatar" src="${recAvatar}" alt="${best.username}"
             onerror="this.onerror=null;this.src='assets/fallbacks/avatar.svg'">
        <div class="who"><strong>${linkBest}</strong><br><span style="color:var(--muted)">${best.date} • ${best.school}</span></div>
        <div class="best time" style="font-weight:600">${fmtTime(best.time)}</div>
        <span class="${pillClass}">${best.conditions||""}</span>
      </div>
    `;
    cards.push(card);
  }
  cards.sort((a,b)=>a.querySelector("h3").textContent.localeCompare(b.querySelector("h3").textContent));
  cards.forEach(c => wrap.appendChild(c));
}

load();
</script>
</body>
</html>
